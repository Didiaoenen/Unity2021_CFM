require("LuaPanda").start("127.0.0.1", 8818)

CS = CS or {}

require("LuaFramework/System")
require("LuaFramework/PathFinder")

local ObjectSourceProxyFactory = require("LuaFramework/ObjectSourceProxyFactory")
local UniversalNodeProxyFactory = require("LuaFramework/UniversalNodeProxyFactory")
local SourceProxyFactory = require("LuaFramework/SourceProxyFactory")
local LiteralSourceProxyFactory = require("LuaFramework/LiteralSourceProxyFactory")
local ExpressionSourceProxyFactory = require("LuaFramework/ExpressionSourceProxyFactory")
local TargetProxyFactory = require("LuaFramework/TargetProxyFactory")
local UniversalTargetProxyFactory = require("LuaFramework/UniversalTargetProxyFactory")
local UnityTargetProxyFactory = require("LuaFramework/UnityTargetProxyFactory")
local StandardBinder = require("LuaFramework/StandardBinder")

local TestVM = require("LuaFramework/TestVM")

function __G__TRACKBACK__(msg)
    error("----------------------------------------")
    error("LUA ERROR: " .. tostring(msg) .. "\n")
    error(debug.traceback())
    error("----------------------------------------")
end

function Main()
    local objectSourceProxyFactory = ObjectSourceProxyFactory()
    objectSourceProxyFactory:Register(UniversalNodeProxyFactory(), 0)

    local sourceProxyFactory = SourceProxyFactory()
    sourceProxyFactory:Register(LiteralSourceProxyFactory(), 0)
    sourceProxyFactory:Register(ExpressionSourceProxyFactory(sourceProxyFactory), 1)
    sourceProxyFactory:Register(objectSourceProxyFactory, 2)

    local targetProxyFactory = TargetProxyFactory()
    targetProxyFactory:Register(UniversalTargetProxyFactory(), 0)
    targetProxyFactory:Register(UnityTargetProxyFactory(), 10)

    local binder = StandardBinder(sourceProxyFactory, targetProxyFactory)

    local testVM = TestVM()
    testVM.Test = 1

    local a = nil
end

local status, msg = pcall(Main, __G__TRACKBACK__)
if not status then
    print(msg)
end