local BindingContext = class("BindingContext")

BindingContext.__getter.DataContext = function(this, k)
    return this.dataContext
end

BindingContext.__setter.DataContext = function(this, k, v)
    if v ~= this.dataContext then
        this.dataContext = v
        this:OnDataContextChanged()
        this:RaiseDataContextChanged()
    end
end

BindingContext.__setter.DataContextChanged = function (this, k, v)
    if v and v.callback ~= nil then
        table.insert(this.dataContextChanged, v)
    else
        for i, value in ipairs(this.dataContextChanged) do
            if v.this == value.this then
                table.remove(this.dataContextChanged, i)
                break
            end
        end
    end
end

function BindingContext:ctor(owner, binder, dataContext)
    self.owner = owner
    self.binder = binder
    self.dataContext = dataContext

    --
    self.bindings = {}
    self.dataContextChanged = {}
    self.DEFAULT_KEY = "_KEY_"
end

function BindingContext:OnDataContextChanged()
    try
    {
        function ()
            for k, binding in pairs(self.bindings) do
                for i, v in ipairs(binding) do
                    v.DataContext = self.dataContext
                end
            end
        end,
        catch = function()
            
        end
    }
end

function BindingContext:RaiseDataContextChanged()
    try
    {
        function ()
            for i, v in ipairs(self.dataContextChanged) do
                v.callback(v.this)
            end
        end,
        catch = function()
            
        end
    }
end

function BindingContext:GetOrCreateList(key)
    if not key then
        key = self.DEFAULT_KEY        
    end

    if not self.bindings[key] then
        self.bindings[key] = {}
    end
    
    return self.bindings[key]
end

function BindingContext:Add(binding, key)
    if not binding then
        return        
    end

    local list = self:GetOrCreateList()
    binding.BindingContext = self
    table.insert(list, binding)
end

function BindingContext:AddBySingleDesc(target, description, key)
    local binding = self.binder:Bind(self, self.dataContext, target, description)
    self:Add(binding, key)
end

function BindingContext:Clear()
    
end

function BindingContext:Dispose()
    self:Clear()
end

return BindingContext